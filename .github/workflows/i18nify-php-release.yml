name: (i18nify-php) Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    name: Create PHP Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: json
          tools: composer:v2

      - name: Install dependencies
        working-directory: packages/i18nify-php
        run: composer install --no-dev --optimize-autoloader

      - name: Run tests
        working-directory: packages/i18nify-php
        run: |
          composer install --dev
          vendor/bin/phpunit

      - name: Determine version
        id: version
        run: |
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "tag_name=php-v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Update composer.json version
        working-directory: packages/i18nify-php
        run: |
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.version.outputs.version }}"/' composer.json || \
          sed -i '/"name":/a \ \ "version": "${{ steps.version.outputs.version }}",' composer.json

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/i18nify-php/composer.json
          git commit -m "chore(php): bump version to ${{ steps.version.outputs.version }}"
          git tag ${{ steps.version.outputs.tag_name }}
          git push origin ${{ steps.version.outputs.tag_name }}

      - name: Generate changelog
        id: changelog
        working-directory: packages/i18nify-php
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.tag_name }}^1 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            git log --pretty=format:"* %s (%h)" $LAST_TAG..${{ steps.version.outputs.tag_name }} -- packages/i18nify-php/ >> RELEASE_NOTES.md
          else
            echo "* Initial release of i18nify PHP SDK" >> RELEASE_NOTES.md
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "## Installation" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "\`\`\`bash" >> RELEASE_NOTES.md
          echo "composer require razorpay/i18nify-php:^${{ steps.version.outputs.version }}" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: "i18nify-php v${{ steps.version.outputs.version }}"
          body_path: packages/i18nify-php/RELEASE_NOTES.md
          draft: false
          prerelease: false

      - name: Notify Packagist
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“¦ Packagist will automatically detect this release"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}" 